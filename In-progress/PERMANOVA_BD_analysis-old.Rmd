--- title: "PERMANOVA & Weighted Unifrac Analysis" output: html_notebook ---

This workbook includes code for running phylogenetic distance based redundancy analyses, based on work from several papers including:

1. Shankar, V., R. Agans, and O. Paliy. "Advantages of phylogenetic distance based constrained ordination analyses for the examination of microbial communities." Scientific Reports 7.1 (2017): 6481.
2.Lee, Sang-Hoon, et al. "Divergent extremes but convergent recovery of bacterial and archaeal soil communities to an ongoing subterranean coal mine fire." The ISME journal 11.6 (2017): 1447.

--- 
It uses the capscle function in vegan to identify correlations between W. Unifrac distances and continuous environmental gradients and categorical data.

```{r}
 
# Imports and libraries 
library(vegan)
library(tidyverse)
library(ggplot2)
library(ggthemes)
library(scales)

# Loading WUF and environmental data:
# BD 
wuf_data = read.table('../Seq_data/Updated_files/beta_WUF_diversity/WUF_dm2.txt')
# environmental data:
env_data = read.table('../Metadata/ibp_metadata_4.17.18.txt', sep='\t', header=TRUE)
meta_table <- read.table('../Seq_data/Updated_files/env_data_ordered_like_biom.txt', header=TRUE, row.names=1, sep='\t')
```

```{r}
# Running capscale:
dbRDA<-capscale(wuf_data ~ USDA_soil_series + WLWNum + cum_depth + pH + inundation_fraction.year_average, data=meta_table) 



plot(dbRDA, main = "dbRDA")dbRDAanova.cca(dbRDA, by="terms")


# Calculating adonis results with basically all of the factors that are likely to affect results:
adonis_results <- adonis(abundance_table_norm ~ USDA_soil_series + WLWNum + cum_depth + pH + inundation_fraction.year_average, data=meta_table)
adonis_results
 
# Now do the CCA:
cca_results <- cca(abundance_table_norm ~ USDA_soil_series + WLWNum + cum_depth + pH + inundation_fraction.year_average, data=meta_table)
scrs<-scores(cca_results,display=c("sp","wa","lc","bp","cn"))
 
#Extract site data first
df_sites<-data.frame(scrs$sites)
df_sites['soil.series'] <- meta_table$USDA_soil_series
df_sites$depth <- meta_table$MicroNum
df_sites['inundation.fraction'] <- meta_table$inundation_fraction.year_average

str(df_sites)

colnames(df_sites) <- c('x','y')

```



```{r}
# Technically, phyloseq is not used during this analysis and this can be excluded.

library(phyloseq)

# Imports:
otumat = read.table('../Seq_data/Updated_files/biom_dropped_missing.txt', header=TRUE, row.names=1, sep='\t')
envmat = read.table('../Seq_data/Updated_files/env_data_ordered_like_biom.txt', header=TRUE, row.names=1, sep='\t')
taxmat = read.table('../Seq_data/Updated_files/taxa_file_ordered_like_biom.txt', header=TRUE, sep='\t', row.names = 1)

# Creating a phyloseq object:
OTU = otu_table(otumat, taxa_are_rows = TRUE)
TAX = tax_table(taxmat2)
ENV = sample_data(envmat)
physeq = phyloseq(OTU, TAX, ENV)

```


Model results thus far -> pH is super important and seems to dominate everything else. A model with soil type (essentially ecocline) and pH explains variation very well

```{r}

env_data

# basic outline of this should look like 
#results <- adonis(wuf_data ~ USDA_soil_series*pH + cum_depth + inundation_fraction.year_average, data = env_data)
results2 <- adonis(wuf_data ~ USDA_soil_series*pH*cum_depth, data = env_data)
results2

# This is good, running this on random noise didn't give me anything close to a significant result.
#env_data['noise'] <- runif(222,0,10)
#results <- adonis(wuf_data ~ noise, data = env_data)





```

I basically want to do a biplot of species abundance and some continuous variable like depth in this case. first I should subset to mc100?

```{r}

# Ordination plotting with phyloseq:
theme_set(theme_bw())
physeq_NMDS <- ordinate(physeq, method = 'NMDS')

```

```{r}
plot_ordination(physeq, ordination = physeq_NMDS, color = 'inundation_fraction.year_average')
```
```{r}
# CCA biplot with adonis significant variables shown:
# Import the OTU table with samples as rows:
abundance_table <-read.delim('../Seq_data/Updated_files/dada_biom_transpose.txt', sep ='\t', row.names=1)
meta_table <- read.table('../Seq_data/Updated_files/env_data_ordered_like_biom.txt', header=TRUE, row.names=1, sep='\t')

# To make adonis/CCA results make more sense, I removed OTUs with < 100 counts:
abundance_table_small = abundance_table[, colSums(abundance_table) > 100]
abundance_table_norm <- abundance_table_small/rowSums(abundance_table_small)

# Calculating adonis results with basically all of the factors that are likely to affect results:
adonis_results <- adonis(abundance_table_norm ~ USDA_soil_series + WLWNum + cum_depth + pH + inundation_fraction.year_average, data=meta_table)
adonis_results
 
# Now do the CCA:
cca_results <- cca(abundance_table_norm ~ USDA_soil_series + WLWNum + cum_depth + pH + inundation_fraction.year_average, data=meta_table)
scrs<-scores(cca_results,display=c("sp","wa","lc","bp","cn"))
 
#Extract site data first
df_sites<-data.frame(scrs$sites)
df_sites['soil.series'] <- meta_table$USDA_soil_series
df_sites$depth <- meta_table$MicroNum
df_sites['inundation.fraction'] <- meta_table$inundation_fraction.year_average

str(df_sites)

colnames(df_sites) <- c('x','y')
runif

p<-ggplot()
p<-p+geom_point(data=df_sites, mapping = aes(x,y, group=soil_type, shape=soil.series, color=inundation.fraction), size=2)

p <- p + scale_color_gradient(low = "#0091ff", high = "#f0650e") + theme_bw()
p <- p + labs(x='CCA1', y='CCA2', shape='Soil Series', color='Inundation Fraction') + ggtitle("Constrained Correspondence Analysis of Bray Curtis Dissimilarities")
p<- p + theme(
  legend.box.background = element_rect(),
  legend.box.margin = margin(6, 6, 6, 6) )
print(p)

# drawing biplot:
multiplier <- vegan:::ordiArrowMul(scrs$biplot)
df_arrows<- scrs$biplot*multiplier

colnames(df_arrows)<-c("x","y")
df_arrows=as.data.frame(df_arrows)
 
p<-p+geom_segment(data=df_arrows, aes(x = 0, y = 0, xend = x, yend = y),
                 arrow = arrow(length = unit(0.2, "cm")),color="#808080",alpha=0.5)
 
p<-p+geom_text(data=as.data.frame(df_arrows*1.1),aes(x, y, label = rownames(df_arrows)),color="#808080",alpha=0.5)
 

print(p)
ggsave("../output/CCA_biplot_crappy.png", width = 7, height = 6)
```

```{r}
# Technically, phyloseq is not used during this analysis and this can be excluded.

library(phyloseq)

# Imports:
otumat = read.table('../Seq_data/Updated_files/biom_dropped_missing.txt', header=TRUE, row.names=1, sep='\t')
envmat = read.table('../Seq_data/Updated_files/env_data_ordered_like_biom.txt', header=TRUE, row.names=1, sep='\t')
taxmat = read.table('../Seq_data/Updated_files/taxa_file_ordered_like_biom.txt', header=TRUE, sep='\t', row.names = 1)

# Creating a phyloseq object:
OTU = otu_table(otumat, taxa_are_rows = TRUE)
TAX = tax_table(taxmat2)
ENV = sample_data(envmat)
physeq = phyloseq(OTU, TAX, ENV)


env_data

# basic outline of this should look like 
#results <- adonis(wuf_data ~ USDA_soil_series*pH + cum_depth + inundation_fraction.year_average, data = env_data)
results2 <- adonis(wuf_data ~ USDA_soil_series*pH*cum_depth, data = env_data)
results2

# This is good, running this on random noise didn't give me anything close to a significant result.
#env_data['noise'] <- runif(222,0,10)
#results <- adonis(wuf_data ~ noise, data = env_data)


# Calculating adonis results with basically all of the factors that are likely to affect results:
adonis_results <- adonis(abundance_table_norm ~ USDA_soil_series + WLWNum + cum_depth + pH + inundation_fraction.year_average, data=meta_table)
adonis_results
 
# Now do the CCA:
cca_results <- cca(abundance_table_norm ~ USDA_soil_series + WLWNum + cum_depth + pH + inundation_fraction.year_average, data=meta_table)
scrs<-scores(cca_results,display=c("sp","wa","lc","bp","cn"))
 


colnames(df_sites) <- c('x','y')


# Ordination plotting with phyloseq:
theme_set(theme_bw())
physeq_NMDS <- ordinate(physeq, method = 'NMDS')
plot_ordination(physeq, ordination = physeq_NMDS, color = 'inundation_fraction.year_average')

# CCA biplot with adonis significant variables shown:
# Import the OTU table with samples as rows:
abundance_table <-read.delim('../Seq_data/Updated_files/dada_biom_transpose.txt', sep ='\t', row.names=1)
meta_table <- read.table('../Seq_data/Updated_files/env_data_ordered_like_biom.txt', header=TRUE, row.names=1, sep='\t')

# To make adonis/CCA results make more sense, I removed OTUs with < 100 counts:
abundance_table_small = abundance_table[, colSums(abundance_table) > 100]
abundance_table_norm <- abundance_table_small/rowSums(abundance_table_small)

# Calculating adonis results with basically all of the factors that are likely to affect results:
adonis_results <- adonis(abundance_table_norm ~ USDA_soil_series + WLWNum + cum_depth + pH + inundation_fraction.year_average, data=meta_table)
adonis_results
 
# Now do the CCA:
cca_results <- cca(abundance_table_norm ~ USDA_soil_series + WLWNum + cum_depth + pH + inundation_fraction.year_average, data=meta_table)
scrs<-scores(cca_results,display=c("sp","wa","lc","bp","cn"))
 
#Extract site data first
df_sites<-data.frame(scrs$sites)
df_sites['soil.series'] <- meta_table$USDA_soil_series
df_sites$depth <- meta_table$MicroNum
df_sites['inundation.fraction'] <- meta_table$inundation_fraction.year_average

str(df_sites)

colnames(df_sites) <- c('x','y')
runif
```

